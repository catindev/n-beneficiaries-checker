# Changelog (этот чат)

## Итоговое состояние
- Все тесты Postman проходят при запуске папок целиком.
- Актуальный endpoint: `POST /beneficiaries/validate`.
- Успех: **200**.
- Ошибки валидации: **422**.
- Комплаенс-блокировки: **403**.

---

## Изменения по шагам

### 1) Приведение коллекции и контракта к актуальному endpoint/status
- Все запросы коллекции переведены на `POST /beneficiaries/validate`.
- Ожидаемый успешный код ответа изменён **202 → 200**.
- Удалены проверки/ожидания поля `request_id`.

### 2) Обязательные поля и новые правила
- Добавлено обязательное поле `beneficiary_id` (payload + правила + тесты).
- Добавлено обязательное поле `passport.doc_type_code`:
  - отсутствует → **422**
  - `doc_type_code = 35` → **403**
- Добавлено обязательное поле `passport.doc_type_name`:
  - отсутствует → **422**

### 3) Новые тестовые сценарии (Postman)
- Добавлен блок тестов на **422 при отсутствии обязательных полей** (включая `beneficiary_id`, `passport.doc_type_code`, `passport.doc_type_name`).
- Добавлены тесты:
  - принятие дат в формате **ДД.ММ.ГГГГ** (нормализация по решению Д-003)
  - **агрегация ошибок**: несколько ошибок в одном ответе
  - **merchant overrides** (M002): обязательность `email` и `phone_ru`

### 4) Fix: ошибка Runner (SyntaxError)
- Исправлены JS-скрипты tests/post-response в двух запросах, из-за которых падал Runner при запуске папок целиком.

### 5) Fix: ложные 422 из-за required_fields (merchant overrides)
Проблема: новые presence-поля для контактов стали включаться «всегда» из-за матчинга по подстроке (`address` → `contacts_postal_address`) и ломали позитивные тесты (422 вместо 200).

Решение:
- Исправлен матчинг `required_fields` → presence-rules:
  - только **точное совпадение** или **префиксное** (`passport` → `passport_*`), без подстрок.
- Добавлены **алиасы** полей мерчанта для вложенных путей:
  - `email` → `contacts_email`
  - `phone_ru` → `contacts_phone_ru`
  - `postal_address` → `contacts_postal_address`
  - `address` → `registration_address`

Результат:
- Папки 4 (позитив) и 5 (warnings) снова дают **200**.
- Override-тесты (M002) проверяют механизм required_fields корректно.

---

## Обновления документации (.md)
- `context.md` — актуализирован: endpoint, статусы, новые правила, новые тесты, фикс required_fields.
- `contract.md` — актуализирован: обязательные поля, форматы дат, правила контактов, per-merchant required_fields и алиасы.
- `decisions_register.md` — актуализирован: добавлены решения по `doc_type_name` и по матчингу required_fields/алиасам.
