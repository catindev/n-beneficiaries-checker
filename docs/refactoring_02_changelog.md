# Refactoring 02 Changelog

- Зафиксированы и внедрены ключевые решения по статусам и ошибкам:
  - `missing fatca_resident/usa_resident` трактуем как `422 VALIDATION_ERROR` (ошибка данных), а не `403`.
  - При наличии блокирующего `REGULATORY`‑триггера возвращаем `403`, но в `errors[]` показываем **весь массив ошибок** (regulatory + validation) для внутренней трассировки.
  - Унифицирован формат ответов также для `400` (например, отсутствие `X‑Merchant‑Id`).
- Канонический формат дат во входном API: **только** `YYYY‑MM‑DD` (прочие форматы → `422`).
- Адреса: чекер не становится интеграционным сервисом; страна определяется структурно по `country_code`.
  - Интерпретация требования «США в адресе» реализована как `country_code=840` (без парсинга строк).
- Логика миграционной карты/ЕАЭС (для будущего fl_nonresident) зафиксирована как допущение: чекер не рассчитывает «30 суток»; исключения по гражданству; отсутствие обеих веток без исключений → `422`; одновременная передача обеих веток не ошибка.
- Признак «документ иностранного гражданина/ЛБГ» (`isForeignIdDoc`) определяется по группе `passport.doc_type_code (31–37, 99)`; входной флаг — только на консистентность. Триггер включения CRS/foreign tax блока: `isForeignIdDoc=ДА` и/или адрес не РФ.
- Введено **реальное версионирование rulesets**:
  - Правила хранятся в `rulesets/<version>/...`.
  - `default.ruleset_version` задаётся в `merchant_config`.
  - Возможен per‑merchant override `merchants[merchantId].ruleset_version`.
  - Реализован fallback: если файла нет в выбранной версии — берём из default‑версии.
  - `rulesetVersion` возвращается в ответе и логируется.
- Обновлены Postman‑тесты:
  - Приведены ожидания под принятые решения (422 вместо 403 для missing FATCA/USA; даты; 400‑ответ).
  - Добавлена отдельная группа демо‑тестов для проверки versioning + fallback.
- Документация:
  - `README.md`: добавлено верхнеуровневое описание сервиса и «главной фичи» — декларативного движка правил + схема пайплайна.
  - `context.md`: обновлён контекст для продолжения разработки в новом чате.
