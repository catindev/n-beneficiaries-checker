# Реестр договорённостей и допущений

**Прототип:** Сервис валидации бенефициаров номинальных счетов (`fl_resident`)
**Дата:** 28.02.2026 | **Версия:** 1.5 | **Статус:** Draft

> **Статусы:** `Закрыт` — решение принято и реализовано в прототипе. `Открыт` — требует уточнения или действия перед продом.

---

## 1. Бизнес-требования и комплаенс

### 1.1 Тип бенефициара и сценарии

| ID    | Решение / Допущение                                                                      | Источник                                                  | Действие                                                                        | Статус   |
| ----- | ---------------------------------------------------------------------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------- | -------- |
| Д-001 | ФЛ-резидент всегда имеет российский документ (код 21), `foreign_doc = НЕТ` автоматически | Допущение для прототипа                                   | Уточнить у БА после прототипа — может ли ФЛ-резидент иметь иностранный документ | `Открыт` |
| Д-002 | Два отдельных адресных поля: `registration_address` и `residence_address`                | БТ — адрес регистрации и адрес пребывания как разные типы | —                                                                               | `Закрыт` |

### 1.2 Форматы и контракт API

| ID    | Решение / Допущение                                                                                                                                                                                                                                                                                 | Источник                                    | Действие                                                               | Статус   |
| ----- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------- | ---------------------------------------------------------------------- | -------- |
| Д-003 | Даты принимаются в форматах `YYYY-MM-DD` и `ДД.ММ.ГГГГ`. Нормализация в `YYYY-MM-DD` до любой валидации на входе в Context Builder. Нераспознанный формат → 422                                                                                                                                     | Договорённость с командой                   | —                                                                      | `Закрыт` |
| Д-006 | HTTP-статусы: `400` — отсутствует заголовок `X-Merchant-Id`, `403` — комплаенс-триггер, `422` — ошибки валидации, `200` — успех                                                                                                                                                                     | Договорённость с командой                   | —                                                                      | `Закрыт` |
| Д-007 | Формат ошибок валидации — массив объектов `{ "field": "<dot.notation>", "message": "<string>" }`                                                                                                                                                                                                    | Договорённость с командой                   | —                                                                      | `Закрыт` |
| Д-025 | `warnings` в ответе присутствует только если есть хотя бы одно предупреждение — поле не передаётся как пустой массив                                                                                                                                                                                | Договорённость с командой                   | —                                                                      | `Закрыт` |
| Д-031 | `n-beneficiaries-checker` — внутренний синхронный сервис-валидатор. Клиент — оркестратор, не мерчант напрямую. Статус успешного ответа `200 { "message": "Ok" }`. `request_id` в ответе отсутствует. Сервис не управляет заявками — только валидирует payload и возвращает вердикт | Архитектурное решение — пересмотр концепции | Обновлены `index.js` и Postman-коллекция (ожидания 202→200, удалены проверки `request_id`) | `Закрыт` |
| Д-033 | `passport.series` и `passport.number` трактуем как **серию и номер паспорта РФ**, а не как номер/серию иностранного документа. Для `fl_resident` считаем РФ-коды документов допустимыми, `doc_type_code=35` (иной документ) — комплаенс-блок. Иностранные коды документов — отдельный кейс по Д-001 | Решение по уточнению контракта | Добавлены правила `passport_doc_type_code_present`, `passport_doc_type_code_blocked` и тесты в Postman | `Закрыт` |
| Д-035 | `passport.doc_type_name` обязателен для `fl_resident`. При отсутствии — 422 с ошибкой по полю `passport.doc_type_name`. | БТ TKBPAY-5453 (п. 11: наименование вида документа) + уточнение по прототипу | Добавить форматное правило и тест-кейс; обновить контракт и контекст | `Закрыт` |
| Д-032 | `X-Merchant-Id` сохраняется в новой архитектуре. Оркестратор передаёт `merchantId` в заголовке. Конфигурация per-мерчант для обязательных полей остаётся                                                                                                                                            | Решение принято                             | —                                                                      | `Закрыт` |
| Д-037 | Механизм `required_fields` для мерчанта: presence-правила включаются по точному совпадению или префиксу (`passport` включает `passport_*`). Добавлены алиасы для вложенных полей: `email`→`contacts_email`, `phone_ru`→`contacts_phone_ru`, `postal_address`→`contacts_postal_address`, `address`→`registration_address`. Это исключает ложные включения по подстроке (например, `address` не должен включать `contacts_postal_address`). | Итог отладки прототипа | Держать логику в `context-builder.js`; тестировать overrides (M002) | `Закрыт` |

### 1.3 Адреса

| ID    | Решение / Допущение                                                                                                                                                                                                                                                            | Источник                                                    | Действие                                                                             | Статус   |
| ----- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------- | ------------------------------------------------------------------------------------ | -------- |
| Д-026 | Адрес РФ передаётся как плоский объект с полями: `region`, `city`, `street` (обязательное), `house` (обязательное), `flat`. Допущение для прототипа — реальный формат ЦФТ/ФИАС уточняется                                                                                      | Допущение для прототипа — официальный формат ЦФТ не получен | Получить спецификацию формата адреса РФ от БА/ЦФТ и заменить структуру               | `Открыт` |
| Д-027 | Иностранный адрес передаётся строкой. Формат не регламентирован                                                                                                                                                                                                                | Комментарий БА                                              | —                                                                                    | `Закрыт` |
| Д-028 | Для определения способа валидации адреса вводится отдельное поле `country_code` — числовой код страны (пример: `643` для РФ). Используется для: выбора между ФИАС-валидацией и строкой, триггера блокировки по США. Классификатор кодов будет описан в клиентской документации | Комментарий БА                                              | Получить классификатор кодов стран и источник (ЦФТ или иной) от БА                   | `Открыт` |
| Д-029 | Gap в БТ — структура адресного параметра не описана, вынесена в клиентскую документацию. Текущая структура в body (`registration_address.country`) — заглушка, подлежит замене                                                                                                 | Gap в БТ                                                    | Обновить body-контракт и правила валидации адреса после получения спецификации от БА | `Открыт` |

### 1.4 Комплаенс и регуляторные правила

| ID    | Решение / Допущение                                                                                                                                                                                                                                                                                                       | Источник                                                                                  | Действие                                                                                                                                                   | Статус   |
| ----- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| Д-008 | При комплаенс-триггере детали не раскрываются мерчанту — единое сообщение без указания причины                                                                                                                                                                                                                            | Регуляторное требование — мерчант не должен знать причину для подбора обходных комбинаций | —                                                                                                                                                          | `Закрыт` |
| Д-010 | Отсутствие полей `fatca_resident` или `usa_resident` → `403`, не `422`. Неизвестное значение регуляторного флага приравнивается к блокировке                                                                                                                                                                              | Комплаенс-решение                                                                         | —                                                                                                                                                          | `Закрыт` |
| Д-013 | `VALIDATION_WARNING` включён в прототип для мягких контролей. Не блокирует заявку. Возвращается в отдельном массиве `warnings`. При успехе — `200 + warnings`                                                                                                                                                             | Договорённость с командой                                                                 | После прототипа вынести на оценку бизнесу и комплаенсу — несут ли мягкие контроли регуляторный риск                                                        | `Открыт` |
| Д-016 | `COMPLIANCE_ESCALATION` — противоречие между флагом и косвенными признаками США. Не блокирует, не возвращается мерчанту. Уходит в audit log для ручной проверки комплаенсом                                                                                                                                               | Gap в БТ — сценарий флаг=НЕТ + косвенные признаки США не описан                           | Уточнить у бизнеса и комплаенса процесс работы с такими заявками                                                                                           | `Открыт` |
| Д-018 | `COMPLIANCE_ESCALATION` фиксируется в audit log отдельным уровнем — не как обычный rejected, а как заявка принятая но требующая внимания                                                                                                                                                                                  | Договорённость с командой                                                                 | Формат записи и процесс работы комплаенса с такими заявками — уточнить у бизнеса                                                                           | `Открыт` |
| Д-021 | `escalations` никогда не возвращаются мерчанту — только в audit log                                                                                                                                                                                                                                                       | Регуляторное требование                                                                   | —                                                                                                                                                          | `Закрыт` |
| Д-030 | Gap в правилах — `COMPLIANCE_ESCALATION` по `FATCA_FLAG_CONTRADICTION` и `USA_FLAG_CONTRADICTION` срабатывают одновременно с `COMPLIANCE_BLOCK`. Сценарий "только эскалация без блока" в текущих правилах невозможен. Решение принято через Д-034: эскалация пишется в audit log рядом с блоком — это корректное и достаточное поведение. | Выявлено при тестировании Postman | — | `Закрыт` |
| Д-034 | **Принцип audit log: приоритет событий влияет только на HTTP-ответ, но не на audit log.** При `COMPLIANCE_BLOCK` в audit log пишется основной статус + все сработавшие `COMPLIANCE_ESCALATION` рядом. Ценность: комплаенс получает полный контекст — не просто "заблокировано по birth_place", но и "флаг FATCA=НЕТ противоречит данным". Больше информации для анализа паттернов и принятия точных решений при ручном разборе. Реализация уже соответствовала принципу, добавлен явный комментарий в `index.js`. | Аналитическое решение | Комментарий добавлен в `index.js` | `Закрыт` |

### 1.5 Конфигурирование и справочники

| ID    | Решение / Допущение                                                                                                                                                  | Источник                  | Действие                                          | Статус   |
| ----- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- | ------------------------------------------------- | -------- |
| Д-004 | Справочник гражданства — ISO 3166-1 alpha-2 до получения справочника ЦФТ. Хранится в `dictionaries/citizenship.json`. Поле `blocked` содержит коды блокируемых стран | Допущение для прототипа   | Заменить на справочник ЦФТ после получения данных | `Открыт` |
| Д-005 | Неизвестный `X-Merchant-Id` → применяется дефолтный конфиг обязательных полей                                                                                        | Договорённость с командой | —                                                 | `Закрыт` |

### 1.6 Форматные правила — fl_resident

| ID    | Решение / Допущение                                                                                     | Источник                                                                               | Действие                                                        | Статус   |
| ----- | ------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------- | --------------------------------------------------------------- | -------- |
| Д-014 | Латиница в ФИО для `fl_resident` недопустима — только кириллица и дефис. Regex: `^[а-яёА-ЯЁ\-]{1,100}$` | БТ — однозначно следует из требований к полям Фамилия/Имя для резидента с паспортом РФ | Для других кейсов (нерезидент, ИП-нерезидент) уточнять отдельно | `Закрыт` |

---

## 2. Технические решения

### 2.1 Архитектура валидационного pipeline

| ID    | Решение                                                                                                                                                                      | Компонент                    | Примечание                                                            |
| ----- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- | --------------------------------------------------------------------- |
| Д-009 | Кастомный оператор `fieldPresent` — проверяет что поле присутствует в запросе (не `null` и не `undefined`). Реализуется в коде как custom operator движка                    | `operators/index.js`         | Решает проблему молчаливого пропуска отсутствующих регуляторных полей |
| Д-011 | Механизм `$ref` на справочники реализуется через препроцессор при загрузке правил. Справочники загружаются один раз при старте сервиса                                       | `config/rule-loader.js`      | Правила не знают конкретных значений справочников — только ссылки     |
| Д-012 | Кастомные операторы: `fieldPresent`, `matchesRegex`, `allSameDigits`, `validInnChecksum`, `notIn`, `containsGarbageChars`, `dateAfterToday`, `dateBefore`, `validDateFormat` | `operators/index.js`         | Граница: условия и связи — в JSON, алгоритмы — в коде                 |
| Д-019 | Сравнение двух полей реализуется через `{ "$fact": "field_name" }` в `value` правила. Резолвинг выполняется препроцессором `fact-resolver.js` до передачи правил в движок    | `operators/fact-resolver.js` | Костыль `birth_date_value` убран                                      |
| Д-020 | Фильтрация правил по конфигу мерчанта работает по суффиксу `_present` в имени правила. Соглашение: все правила на обязательность поля именуются `{field_name}_present`       | `context-builder.js`         | Соглашение обязательно для всех новых правил                          |

### 2.2 Типы событий движка

| ID     | Решение                                                                                                                                                    | Компонент            | Примечание                                                                |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------------------- |
| Д-013т | Четыре типа событий: `COMPLIANCE_BLOCK` → 403, `VALIDATION_ERROR` → 422, `VALIDATION_WARNING` → 200 + warnings, `COMPLIANCE_ESCALATION` → только audit log | `context-builder.js` | Приоритет: `COMPLIANCE_BLOCK` > `VALIDATION_ERROR` > `VALIDATION_WARNING` |

### 2.3 Нормализация и препроцессинг

| ID    | Решение                                                                                                             | Компонент            | Примечание                                                   |
| ----- | ------------------------------------------------------------------------------------------------------------------- | -------------------- | ------------------------------------------------------------ |
| Д-022 | `normalizeDates` делает глубокую копию payload через `JSON.parse(JSON.stringify())` — исходный объект не мутируется | `context-builder.js` | —                                                            |
| Д-017 | Кастомные операторы для дат работают с нормализованным форматом `YYYY-MM-DD` после препроцессора                    | `operators/index.js` | Зависит от Д-003 — нормализация должна быть выполнена первой |

### 2.4 Audit Log

| ID    | Решение                                                                                                                                                         | Компонент  | Примечание                                       |
| ----- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ------------------------------------------------ |
| Д-023 | В прототипе audit log пишется в консоль. Формат записи зафиксирован: `timestamp`, `event`, `merchantId`, `beneficiary_type`, `inn`, `request_id`, `escalations` | `index.js` | В проде заменить на отдельный сервис или таблицу |
| Д-024 | При `500` детали ошибки мерчанту не раскрываются — только в audit log. Мерчант получает универсальное сообщение                                                 | `index.js` | —                                                |

---

## 3. Открытые вопросы — требуют действий перед продом

| ID    | Действие                                                                                                 | Владелец             | Срок                          |
| ----- | -------------------------------------------------------------------------------------------------------- | -------------------- | ----------------------------- |
| Д-001 | Уточнить у БА — может ли ФЛ-резидент иметь иностранный документ                                          | БА                   | До перехода в прод            |
| Д-004 | Заменить справочник гражданства ISO на справочник ЦФТ                                                    | Разработка           | После получения данных от ЦФТ |
| Д-013 | Вынести `VALIDATION_WARNING` на оценку бизнесу и комплаенсу — несут ли мягкие контроли регуляторный риск | Аналитик             | После демо прототипа          |
| Д-016 | Уточнить у бизнеса и комплаенса процесс работы с заявками типа `COMPLIANCE_ESCALATION`                   | Аналитик + Комплаенс | До перехода в прод            |
| Д-018 | Согласовать формат записи escalation в audit log и процесс ручной обработки комплаенсом                  | Аналитик + Комплаенс | До перехода в прод            |
| Д-026 | Получить спецификацию формата адреса РФ от БА/ЦФТ и заменить плоский объект-заглушку                     | Аналитик + БА        | До написания ТЗ на разработку |
| Д-028 | Получить классификатор кодов стран и источник от БА, добавить в `dictionaries/`                          | Аналитик + БА        | До написания ТЗ на разработку |
| Д-029 | Обновить body-контракт и правила валидации адреса после получения спецификации                           | Разработка           | После закрытия Д-026 и Д-028  |

## Д-036 — Сопоставление required_fields для presence-правил (контакты/адрес)
**Статус:** Закрыто

**Проблема:** substring-матч required_fields приводил к ложному включению presence-правил (например, `address` включал `contacts_postal_address_present`).

**Решение:** введено явное сопоставление (aliases) и префиксное сравнение `fieldName === f || fieldName.startsWith(f + '_')`.
