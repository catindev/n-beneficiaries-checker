# Контекст разработки прототипа: Сервис валидации бенефициаров

## Как использовать этот документ

Загрузи в новый чат:
1. Этот файл `CONTEXT.md`
2. Архив с кодом проекта (содержит `decisions_register.md`)
3. Документ с БТ (`TKBPAY-5453_БТ.docx`)

Скажи Claude: _"Прочитай CONTEXT.md и продолжим разработку"_

---

## Проект

**Название:** n-beneficiaries-checker
**Задача:** Сервис валидации бенефициаров номинальных счетов (REST API)
**БТ:** TKBPAY-5453
**Стек:** Node.js, Express, json-rules-engine, uuid, nodemon

---

## Что уже сделано

### Прототип покрывает: `fl_resident` (физлицо-резидент)

Реализованы и протестированы:
- Регуляторные блокировки (FATCA, USA_RESIDENT, косвенные признаки США)
- Форматная валидация (ИНН, ФИО, паспорт, гражданство, даты, адрес)
- Кросс-поля (даты, контакты, адресная логика)
- Мягкие контроли (warnings)
- Комплаенс-эскалации (audit log, не возвращаются мерчанту)
- Конфигурирование обязательных полей per-мерчант
- Нормализация дат (YYYY-MM-DD и ДД.ММ.ГГГГ)

**Postman коллекция:** 50 запросов/тестов, все проходят. Тест 3.7 удалён ранее как недостижимый — закрыт через Д-034 (эскалации пишутся в audit log рядом с блоком, это корректное поведение).

> **Архитектурное изменение [Д-031]:** endpoint `/beneficiaries/validate`, статус успеха `200 { message: "Ok" }`, `request_id` упразднён. Коллекция обновлена (ожидания 202→200, удалены проверки request_id).

---

## Структура проекта

```
n-beneficiaries-checker/
├── index.js                          # Express endpoint, audit log, HTTP-ответы
├── context-builder.js                # v1.5 — главная логика: нормализация → правила → движок
├── operators/
│   └── fact-resolver.js              # резолвинг { "$fact": "field_name" } между полями
├── config/
│   ├── rule-loader.js                # загрузка правил (используется context-builder)
│   └── merchant_config.json          # дефолт + overrides per-мерчант
├── dictionaries/
│   ├── citizenship.json              # ISO 3166-1 alpha-2, поле blocked: ["US"]
│   └── country_codes.json            # числовые коды стран, blocked_codes: [840]
├── rules/
│   ├── regulatory/
│   │   ├── fatca.json                # FATCA и USA_RESIDENT флаги + отсутствие полей
│   │   └── usa_links.json            # косвенные признаки США (birth_place, citizenship, адрес)
│   └── fl_resident/
│       ├── format.json               # ИНН, ФИО, паспорт, гражданство, адрес — форматные
│       └── cross_fields.json         # даты, контакты, адресная логика, эскалации
├── body_fl_resident.json             # пример валидного запроса
├── decisions_register.md             # реестр договорённостей v1.2 (30 решений)
└── postman_fl_resident.json          # коллекция Postman (33 теста)
```

---

## Архитектура — ключевые решения

### Роль сервиса [Д-031]

`n-beneficiaries-checker` — **внутренний синхронный сервис-валидатор**.
Клиент — оркестратор, не мерчант напрямую. Сервис не управляет заявками.
Метафора: пограничник — видит payload, прогоняет через правила, возвращает вердикт.

### HTTP контракт
```
POST /beneficiaries/validate
Headers:
  X-Merchant-Id  — обязательный, для выбора конфига обязательных полей per-мерчант [Д-032]
  X-Request-Id   — опциональный, ID заявки оркестратора для audit log

400 — отсутствует X-Merchant-Id
403 — COMPLIANCE_BLOCK (детали не раскрываются, оркестратор останавливает заявку)
422 — VALIDATION_ERROR { message, errors: [{field, message}], warnings?: [...] }
200 — успех { message: "Ok", warnings?: [...] }
500 — внутренняя ошибка (детали только в audit log)
```

**Важно:** `warnings` не останавливают процесс у оркестратора — передаются для финмониторинга.

### Типы событий движка (json-rules-engine)
| Тип | HTTP | Видим мерчанту |
|-----|------|----------------|
| `COMPLIANCE_BLOCK` | 403 | Только generic message |
| `VALIDATION_ERROR` | 422 | errors[] с field и message |
| `VALIDATION_WARNING` | 200 | warnings[] |
| `COMPLIANCE_ESCALATION` | — | Только в audit log |

**Приоритет:** COMPLIANCE_BLOCK > VALIDATION_ERROR > VALIDATION_WARNING

### Правила — соглашения
- Правила на обязательность поля именуются `{field_name}_present` — фильтруются по конфигу мерчанта
- `$ref` на справочники: `{ "$ref": "dictionaries.citizenship.blocked" }` — резолвится при загрузке
- `$fact` для кросс-полей: `{ "$fact": "birth_date" }` — резолвится через `fact-resolver.js`
- Операторы: `fieldPresent`, `matchesRegex`, `allSameDigits`, `validInnChecksum`, `notIn`, `containsGarbageChars`, `contains`, `dateAfterToday`, `dateBefore`, `validDateFormat`

### Ключевые механизмы context-builder.js (v1.5)
1. Проверка `beneficiary_type`
2. Нормализация дат (YYYY-MM-DD / ДД.ММ.ГГГГ → YYYY-MM-DD, fail fast на 422)
3. Загрузка справочников + `country_codes.values_keys` (массив числовых ключей)
4. Загрузка правил + резолвинг `$ref`
5. Загрузка конфига мерчанта (неизвестный мерчант → дефолт)
6. `flattenPayload` — объект в dot-notation факты
7. `resolveFactRefs` — подстановка `$fact`
8. `collectFactPaths` — сбор всех путей из правил → `null` для отсутствующих (без хардкода)
9. Создание движка + регистрация операторов
10. Фильтрация `_present` правил по конфигу мерчанта
11. Прогон движка
12. Агрегация по типам событий
13. Возврат результата

### Адреса (Д-026, Д-027, Д-028) — ЗАГЛУШКА
- РФ (`country_code: 643`): плоский объект `{ country_code, region, city, street*, house*, flat }` — допущение до получения формата ЦФТ
- Иностранный: `{ country_code, address_str* }` — строка
- `country_code` — числовой, из справочника `country_codes.json`, `840` = блокировка

### ИНН физлица — валидный тестовый
`771234567859` — прошёл алгоритм ФНС, использовать во всех тестах позитивных сценариев

---

## Открытые вопросы перед продом (из decisions_register.md)

| ID | Суть | Владелец |
|----|------|----------|
| Д-001 | Может ли ФЛ-резидент иметь иностранный документ? | БА |
| Д-004 | Заменить справочник гражданства ISO на ЦФТ | Разработка |
| Д-013 | VALIDATION_WARNING — регуляторный риск? | Аналитик + Комплаенс |
| Д-016 | Процесс работы с COMPLIANCE_ESCALATION заявками | Аналитик + Комплаенс |
| Д-018 | Формат записи escalation и SLA ручной обработки | Аналитик + Комплаенс |
| Д-026 | Спецификация ФИАС-структуры адреса РФ от БА/ЦФТ | Аналитик + БА |
| Д-028 | Классификатор числовых кодов стран от БА/ЦФТ | Аналитик + БА |
| Д-029 | Обновить контракт адреса после Д-026 и Д-028 | Разработка |
| Д-034 | ~~Д-030 закрыт~~ Принцип audit log зафиксирован: приоритет событий → только HTTP-ответ, escalations всегда в audit log | Закрыт |

---

## Что делать дальше

### Следующий приоритет — расширение на другие типы бенефициаров

Порядок реализации (по объёму и сложности):
1. **`ul_resident`** — юридическое лицо резидент (ОГРН, КПП, двухфазный флоу с ЕГРЮЛ)
2. **`ip_resident`** — ИП резидент (ОГРНИП, двухфазный флоу с ЕГРИП)
3. **`ul_nonresident`** — юридическое лицо нерезидент
4. **`ip_nonresident`** — ИП нерезидент
5. **`fl_nonresident`** — физлицо нерезидент (иностранный документ, IINN, миграционная карта)

Для каждого типа нужно создать:
- `rules/{type}/format.json`
- `rules/{type}/cross_fields.json`
- Дополнить `postman_fl_resident.json` или создать отдельную коллекцию

### Интеграции (не реализованы в прототипе)
- **ЕГРЮЛ/ЕГРИП** — двухфазный флоу для резидентов ЮЛ и ИП (проверка существования + финальная регистрация)
- **АБС ЦФТ** — сценарии 1-4 по БТ (проверка бенефициара перед созданием)
- **Kafka** — рассматривалась для гарантии доставки в регуляторном контексте; решение отложено

### Технический долг
- Audit log → отдельный сервис/таблицу (сейчас console.log)
- Unit-тесты кастомных операторов
- Интеграционные тесты для всех типов бенефициаров
- Нагрузочное тестирование (RPS не определён)
- Справочники → заменить заглушки на данные ЦФТ (Д-004, Д-028)

---

## Контекст роли

Разработку ведёт системный аналитик банковского проекта. Функции:
- Валидация и критический фильтр бизнес-требований
- Разработка ТЗ для разработчиков
- Экспертные консультации для разработчиков
- Тестирование и приёмка разработанных сервисов

При продолжении разработки Claude выступает в роли разработчика и технического советника. Все архитектурные решения согласуются с аналитиком. Новые допущения фиксируются в `decisions_register.md`.
